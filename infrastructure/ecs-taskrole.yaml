AWSTemplateFormatVersion: '2010-09-09'
Description: ECS Service Launch

Parameters:
  Prefix:
    Description: Prefix Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: continuous-perftest

Resources:
  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      RoleName: !Sub ${Prefix}-ECSTaskRole
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com

  SQSAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${Prefix}-SQSAccessPolicy
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
              - "sqs:ReceiveMessage"
              - "sqs:GetQueueUrl"
            Resource: !ImportValue SQS-Arn
      Roles:
        - !Ref ECSTaskRole

  DynamoDBAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${Prefix}-DynamoDBAccessPolicy
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:DescribeTable"
              - "dynamodb:Get*"
              - "dynamodb:Query"
              - "dynamodb:Scan"
              - "dynamodb:Delete*"
              - "dynamodb:Update*"
              - "dynamodb:PutItem"
            Resource:
              Fn::ImportValue: !Sub ${Prefix}-Table-Arn
      Roles:
        - !Ref ECSTaskRole

  S3AccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${Prefix}-S3AccessPolicy
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - "s3:PutObject"
              - "s3:GetObject"
              - "s3:ListBucket"
            Resource: !Sub arn:aws:s3:::${Prefix}-bucket
      Roles:
        - !Ref ECSTaskRole

  CodepipelineAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${Prefix}-CodepipelineAccessPolicy
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - "codepipeline:GetPipeline"
              - "codepipeline:GetPipelineState"
              - "codepipeline:GetPipelineExecution"
              - "codepipeline:ListPipelineExecutions"
              - "codepipeline:ListPipelines"
              - "codepipeline:PutApprovalResult"
            Resource: "*"
      Roles:
        - !Ref ECSTaskRole

Outputs:
  ECSTaskRole:
    Description:  ECS Task has role
    Value: !GetAtt ECSTaskRole.Arn
    Export:
      Name: !Sub ${Prefix}-ECSTaskRole